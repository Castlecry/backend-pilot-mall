# Pilot-Mall 接口文档

## 项目概述

Pilot-Mall 是一个基于微服务架构的电商系统，支持高并发秒杀和 AI 智能导购功能。

### 核心功能
- 用户注册与登录（JWT 认证）
- 高并发秒杀下单（Redis + Lua 脚本）
- 异步订单处理（RabbitMQ 消息队列）
- AI 智能导购（LangChain4j + Ollama）

---

## 技术栈

### 后端
- Spring Boot 3.3
- Spring Cloud Gateway（API 网关）
- Spring Cloud Alibaba Nacos（服务注册与发现）
- MyBatis（持久层）
- Redis（缓存与库存）
- RabbitMQ（消息队列）
- LangChain4j + Ollama（AI 导购）

### 前端建议
- Vue 3 / React 18
- Ant Design / Element Plus
- Axios（HTTP 请求）
- Pinia / Redux（状态管理）

---

## 基础信息

### 网关地址
```
http://localhost:8084
```

### 认证方式
所有需要认证的接口需在请求头中携带 JWT Token：

```http
Authorization: Bearer {token}
```

---

## 接口列表

### 1. 用户登录

#### 接口信息
- **接口路径**：`POST /api/user/login`
- **功能描述**：用户登录，返回 JWT Token
- **是否需要认证**：否

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|--------|------|
| username | String | 是 | 用户名 |
| password | String | 是 | 密码 |

#### 请求示例
```json
{
  "username": "test",
  "password": "123456"
}
```

#### 响应示例
```json
{
  "code": 200,
  "message": "操作成功",
  "data": "eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIxIiwidXNlcm5hbWUiOiJ0ZXN0IiwiaWF0IjoxNzcwNjAxMzY0LCJleHAiOjE3NzA2ODc3NjR9.Kp1-tBf5TknHNebBLTge5VoO2h4L4CZY8qALABGqyho"
}
```

#### 错误码
| 错误码 | 说明 |
|--------|------|
| 500 | 用户名或密码错误 |

---

### 2. 商品列表

#### 接口信息
- **接口路径**：`GET /api/product/list`
- **功能描述**：获取所有商品列表
- **是否需要认证**：否

#### 请求参数
无

#### 请求示例
```http
GET http://localhost:8084/api/product/list
```

#### 响应示例
```json
{
  "code": 200,
  "message": "操作成功",
  "data": [
    {
      "id": 1,
      "name": "智能手表",
      "price": 299.00,
      "stock": 100,
      "description": "这款智能手表支持心率监测、睡眠分析、运动模式等多种功能，续航长达7天，防水等级IP68，适合日常运动和商务场合。"
    }
  ]
}
```

#### 错误码
| 错误码 | 说明 |
|--------|------|
| 500 | 获取商品列表失败 |

---

### 3. 商品库存查询

#### 接口信息
- **接口路径**：`GET /api/product/stock`
- **功能描述**：查询商品库存（从 Redis 读取）
- **是否需要认证**：否

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|--------|------|
| productId | Long | 是 | 商品ID |

#### 请求示例
```http
GET http://localhost:8084/api/product/stock?productId=1
```

#### 响应示例
```json
{
  "code": 200,
  "message": "操作成功",
  "data": 99
}
```

#### 错误码
| 错误码 | 说明 |
|--------|------|
| 500 | 商品不存在 |

---

### 4. 秒杀下单

#### 接口信息
- **接口路径**：`POST /api/order/create`
- **功能描述**：创建秒杀订单，异步处理
- **是否需要认证**：是

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|--------|------|
| productId | Long | 是 | 商品ID |

#### 请求示例
```json
{
  "productId": 1
}
```

#### 响应示例
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "orderSn": "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0",
    "productId": 1,
    "totalAmount": 299.00,
    "status": 0
  }
}
```

#### 错误码
| 错误码 | 说明 |
|--------|------|
| 500 | 商品不存在 |
| 500 | 已售罄 |
| 401 | 未登录或 Token 过期 |

---

### 5. AI 导购

#### 接口信息
- **接口路径**：`POST /api/ai/chat`
- **功能描述**：基于商品信息的智能导购咨询
- **是否需要认证**：否

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|--------|------|
| productId | Long | 是 | 商品ID |
| message | String | 是 | 用户问题 |

#### 请求示例
```json
{
  "productId": 1,
  "message": "这个产品好在哪里？"
}
```

#### 响应示例
```json
{
  "code": 200,
  "message": "操作成功",
  "data": "这款智能手表具有以下优势：\n\n1. 多功能监测：支持心率监测、睡眠分析、运动模式等多种健康数据追踪。\n2. 超长续航：续航长达7天，无需频繁充电。\n3. 高级防护：防水等级IP68，适合游泳、洗澡等场景。\n4. 多场景适用：无论是日常运动还是商务场合，都能完美搭配。\n\n如果您对某项功能有更多疑问，欢迎继续咨询！"
}
```

#### 错误码
| 错误码 | 说明 |
|--------|------|
| 500 | 商品不存在 |
| 500 | AI 服务不可用 |

---

## 统一响应格式

所有接口返回统一格式：

```json
{
  "code": 200,
  "message": "操作成功",
  "data": {}
}
```

### 状态码说明

| 状态码 | 说明 |
|--------|------|
| 200 | 操作成功 |
| 401 | 未登录或 Token 过期 |
| 403 | 没有相关权限 |
| 404 | 参数校验失败 |
| 500 | 操作失败 |

---

## 前端项目建议

### 项目结构

```
pilot-mall-frontend/
├── src/
│   ├── api/              # API 接口封装
│   │   ├── user.js      # 用户相关接口
│   │   ├── product.js   # 商品相关接口
│   │   └── order.js    # 订单相关接口
│   ├── views/            # 页面组件
│   │   ├── Login/       # 登录页
│   │   ├── Product/     # 商品列表页
│   │   ├── Seckill/      # 秒杀页
│   │   ├── Order/       # 订单页
│   │   └── AIChat/      # AI 导购页
│   ├── store/            # 状态管理
│   │   ├── user.js
│   │   └── token.js
│   └── utils/            # 工具函数
│       ├── request.js   # Axios 封装
│       └── auth.js      # Token 管理
```

### 页面设计建议

#### 1. 登录页（Login）

**UI 要求**：
- 居中布局，简洁大气
- 用户名/密码输入框，带图标
- 记住密码选项
- 登录按钮，带加载状态
- 错误提示，Toast 消息

**交互流程**：
1. 用户输入用户名密码
2. 点击登录按钮
3. 调用登录接口
4. 保存 Token 到本地存储
5. 跳转到秒杀页

---

#### 2. 秒杀页（Seckill）

**UI 要求**：
- 商品卡片列表，横向滚动
- 每个卡片显示：商品图片、名称、价格、库存
- 库存实时显示（建议使用定时器轮询 `/api/product/stock` 接口）
- 立即购买按钮，带倒计时
- 已售罄商品按钮置灰

**交互流程**：
1. 页面加载时调用 `/api/product/list` 获取商品列表
2. 定时器每 3 秒调用 `/api/product/stock` 更新库存显示
3. 用户点击购买按钮
4. 调用下单接口
5. 显示下单成功弹窗
6. 跳转到订单页

**视觉建议**：
- 秒杀主题：红色/橙色为主色调
- 倒计时：大字体，醒目
- 库存：数字跳动效果
- 按钮：渐变背景，悬停效果

---

#### 3. 订单页（Order）

**UI 要求**：
- 订单列表，卡片式布局
- 每个订单显示：订单号、商品信息、金额、状态
- 状态标签：待支付（黄色）、已完成（绿色）、已关闭（灰色）
- 订单详情弹窗

**交互流程**：
1. 页面加载时获取订单列表
2. 点击订单查看详情
3. 支持刷新按钮

**状态说明**：
| 状态 | 颜色 | 说明 |
|------|--------|------|
| 待支付 | 黄色 | 订单已创建，等待支付 |
| 已完成 | 绿色 | 订单已支付完成 |
| 已关闭 | 灰色 | 订单已取消 |
| 无效订单 | 红色 | 订单异常 |

---

#### 4. AI 导购页（AI Chat）

**UI 要求**：
- 聊天气泡布局，类似微信/钉钉
- 左侧：用户消息气泡（白色）
- 右侧：AI 回复气泡（蓝色）
- 底部：输入框，带发送按钮
- 顶部：商品信息卡片（可折叠）

**交互流程**：
1. 页面加载时显示商品信息
2. 用户输入问题
3. 调用 AI 接口
4. 显示 AI 回复（打字机效果）
5. 支持多轮对话

**视觉建议**：
- AI 回复：Markdown 渲染，支持代码块
- 加载状态：打字机动画
- 输入框：多行文本，支持 Enter 发送
- 滚动：自动滚动到最新消息

---

## 接口调用示例

### Axios 封装

```javascript
import axios from 'axios';

const request = axios.create({
  baseURL: 'http://localhost:8084',
  timeout: 10000
});

request.interceptors.request.use(config => {
  const token = localStorage.getItem('token');
  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  return config;
});

export default request;
```

### 用户登录接口

```javascript
import request from '@/utils/request';

export const login = (username, password) => {
  return request.post('/api/user/login', { username, password });
};
```

### 商品列表接口

```javascript
import request from '@/utils/request';

export const getProductList = () => {
  return request.get('/api/product/list');
};
```

### 商品库存接口

```javascript
import request from '@/utils/request';

export const getProductStock = (productId) => {
  return request.get('/api/product/stock', { params: { productId } });
};
```

### 下单接口

```javascript
import request from '@/utils/request';

export const createOrder = (productId) => {
  return request.post('/api/order/create', { productId });
};
```

### AI 导购接口

```javascript
import request from '@/utils/request';

export const aiChat = (productId, message) => {
  return request.post('/api/ai/chat', { productId, message });
};
```

---

## 测试数据

### 测试账号
```
用户名：test
密码：123456
```

### 测试商品
```sql
INSERT INTO pms_product (name, price, stock, description) 
VALUES ('智能手表', 299.00, 100, '这款智能手表支持心率监测、睡眠分析、运动模式等多种功能，续航长达7天，防水等级IP68，适合日常运动和商务场合。');
```

---

## 注意事项

1. **Token 管理**：登录成功后需保存 Token，每次请求携带
2. **错误处理**：统一处理 401 错误，跳转到登录页
3. **库存同步**：秒杀页建议使用定时器轮询 `/api/product/stock` 接口，每 3 秒更新一次
4. **AI 超时**：AI 接口响应可能较慢，需显示加载状态
5. **订单状态**：订单创建后状态为 0（待支付），需轮询更新

---

## 核心功能说明

### 1. 接口幂等性（防重复下单）

**设计目的**：防止用户在短时间内重复提交订单，避免重复扣减库存。

**实现方式**：
- 基于 Redis 的 `setIfAbsent` 原子操作
- 生成唯一标识：`seckill:order:unique:{userId}:{productId}`
- 设置 5 分钟过期时间

**效果**：
- 同一用户对同一商品，5 分钟内只能下单一次
- 返回错误：`请勿重复下单`

---

### 2. 接口限流

**设计目的**：防止接口被恶意刷单，保护服务稳定性。

**实现方式**：
- 基于 Redis 的 `incr` 操作实现固定窗口限流
- 使用 AOP 切面，通过 `@RateLimit` 注解标注
- 限流规则：单个用户 60 秒内最多调用 5 次秒杀接口

**效果**：
- 超过限流阈值：返回 `请求太频繁，请稍后重试`
- 保护服务：避免高并发导致服务崩溃

---

### 3. 日志分级

**设计目的**：方便问题排查，区分正常流程和异常情况。

**日志级别**：
- `log.info()`：正常流程日志（用户开始秒杀、订单入库成功）
- `log.warn()`：警告日志（库存不足、商品不存在）
- `log.error()`：错误日志（订单处理失败、系统异常）

**效果**：
- 快速定位问题：通过日志级别快速筛选问题
- 审计追踪：记录用户操作轨迹

---

## 联系方式

如有问题，请联系后端开发团队。
